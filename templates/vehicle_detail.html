{% extends "base.html" %}

{% block title %}{{ vehicle.make }} {{ vehicle.model }} - Vehicle Rental System{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <a href="{{ url_for('customer.vehicles') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Vehicles
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <img src="{{ url_for('static', filename='images/' + vehicle.__class__.__name__.lower() + '.jpg') }}" 
                 class="card-img-top" 
                 alt="{{ vehicle.make }} {{ vehicle.model }}"
                 onerror="this.src='{{ url_for('static', filename='images/default.jpg') }}'">
            <div class="card-body">
                <h2 class="card-title">{{ vehicle.make }} {{ vehicle.model }}</h2>
                <p class="lead">
                    <span class="badge bg-secondary">{{ vehicle.__class__.__name__ }}</span>
                    <span class="badge bg-info">{{ vehicle.year }}</span>
                </p>
                
                <h3 class="text-primary mb-3">${{ vehicle.daily_rate|round(2) }}<small class="text-muted">/day</small></h3>
                
                <h5>Specifications:</h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Vehicle ID:</strong></span>
                        <code>{{ vehicle.vehicle_id }}</code>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Make:</strong></span>
                        <span>{{ vehicle.make }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Model:</strong></span>
                        <span>{{ vehicle.model }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Year:</strong></span>
                        <span>{{ vehicle.year }}</span>
                    </li>
                    {% if vehicle.__class__.__name__ == 'Car' %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Doors:</strong></span>
                        <span>{{ vehicle.num_doors }}</span>
                    </li>
                    {% elif vehicle.__class__.__name__ == 'Motorbike' %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Engine:</strong></span>
                        <span>{{ vehicle.engine_cc }}cc</span>
                    </li>
                    {% elif vehicle.__class__.__name__ == 'Truck' %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Load Capacity:</strong></span>
                        <span>{{ vehicle.load_capacity_tons }}t</span>
                    </li>
                    {% endif %}
                </ul>
                
                {% if user.kind != 'Staff' %}
                <div class="d-grid gap-2">
                    <a href="{{ url_for('customer.rent_vehicle', vehicle_id=vehicle.vehicle_id) }}" class="btn btn-success btn-lg">
                        <i class="bi bi-cart-plus"></i> Rent This Vehicle
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Rental Information</h5>
            </div>
            <div class="card-body">
                <h6>Your Discount:</h6>
                {% if user.kind == 'Corporate' %}
                <p class="text-success"><strong>15% discount</strong> on all rentals as a Corporate user!</p>
                {% elif user.kind == 'Individual' %}
                <p class="text-success"><strong>10% discount</strong> for rentals of 7 days or more!</p>
                {% else %}
                <p class="text-muted">Staff members cannot rent vehicles.</p>
                {% endif %}
                
                {% if user.kind != 'Staff' %}
                <h6 class="mt-3">Price Breakdown:</h6>
                <ul>
                    <li>Base rate: ${{ vehicle.daily_rate|round(2) }}/day</li>
                    {% if vehicle.__class__.__name__ == 'Car' %}
                        {% if vehicle.num_doors <= 2 %}
                        <li>Sports car premium: +10%</li>
                        {% elif vehicle.num_doors >= 5 %}
                        <li>Large vehicle premium: +5%</li>
                        {% endif %}
                    {% elif vehicle.__class__.__name__ == 'Motorbike' %}
                        <li>Helmet fee: $5/day</li>
                        {% if vehicle.engine_cc >= 600 %}
                        <li>High displacement premium: +5%</li>
                        {% endif %}
                    {% elif vehicle.__class__.__name__ == 'Truck' %}
                        <li>Logistics fee: $20</li>
                        {% if vehicle.load_capacity_tons > 3.0 %}
                        <li>Heavy load surcharge: +10%</li>
                        {% endif %}
                    {% endif %}
                    <li>Your discount applied at checkout</li>
                </ul>
                <h6 class="mt-3">RETURN POLICY :</h6>
                <ul>
                    <li>Return the vehicle on or before the end date, if no damages, no extra charge will be charged.</li>
                    <li>Return the vehicle before the start date, 50% of the rental cost will be charged.</li>
                    <li>If the vehicle is returned late, a late fee will be charged.</li>
                </ul>
                {% endif %}
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Availability Calendar</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Green dates are available, Red dates are booked.</p>
                
                <!-- Calendar Navigation -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-primary btn-sm" id="prev-month">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <h5 class="mb-0 text-primary" id="current-month"></h5>
                    <button class="btn btn-outline-primary btn-sm" id="next-month">
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Calendar Grid -->
                <div id="calendar-container"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Rental History</h5>
            </div>
            <div class="card-body">
                {% if rental_history %}
                <p class="text-muted">This vehicle has been rented <strong>{{ rental_history|length }}</strong> time(s).</p>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rental in rental_history | reverse %}
                            <tr>
                                <td>{{ rental.period.start_date }} to {{ rental.period.end_date }}</td>
                                <td>
                                    {% if rental.returned %}
                                    <span class="badge bg-success">Returned</span>
                                    {% else %}
                                    <span class="badge bg-primary">Active</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">This vehicle has not been rented yet. Be the first!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .card-img-top {
        height: 300px;
        object-fit: cover;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .calendar-header {
        text-align: center;
        font-weight: bold;
        padding: 10px;
        background-color: #0d6efd;
        color: white;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .calendar-day {
        text-align: center;
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
        min-height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .calendar-day:hover:not(.empty):not(.past) {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-day.empty {
        background-color: transparent;
        border: none;
        cursor: default;
    }
    
    .calendar-day.available {
        background-color: #d1e7dd;
        color: #0f5132;
        border-color: #a3cfbb;
        font-weight: 500;
    }
    
    .calendar-day.booked {
        background-color: #f8d7da;
        color: #842029;
        border-color: #f1aeb5;
        font-weight: 500;
    }
    
    .calendar-day.past {
        background-color: #e9ecef;
        color: #adb5bd;
        border-color: #ced4da;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .calendar-day.unavailable-after-2pm {
        background-color: #e9ecef;
        color: #adb5bd;
        border-color: #ced4da;
        cursor: not-allowed;
        opacity: 0.6;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const bookedRanges = {{ booked_ranges|safe }};
    let currentMonth = 0; // Offset from today's month (0 = current month)
    
    // Check if a date is affected by 14:00 rule (should be grayed out)
    function isDateAffectedBy14Rule(date) {
        const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const today = new Date();
        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        // If checking today's date and current time is after 14:00 (2 PM), mark as affected
        if (checkDate.getTime() === todayStart.getTime()) {
            const currentHour = today.getHours();
            if (currentHour >= 14) {
                return true; // Today is affected by 14:00 rule
            }
        }
        return false;
    }
    
    // Check if a date is booked (actual bookings)
    function isDateBooked(date) {
        // Normalize the input date to start of day for comparison
        const checkDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        
        for (let range of bookedRanges) {
            const start = new Date(range.start);
            const end = new Date(range.end);
            
            // Normalize range dates to start of day
            const rangeStart = new Date(start.getFullYear(), start.getMonth(), start.getDate());
            const rangeEnd = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            
            // Check if the date falls within the range (inclusive)
            if (checkDate >= rangeStart && checkDate <= rangeEnd) {
                return true;
            }
        }
        return false;
    }
    
    // Generate calendar for a specific month
    function generateCalendar(monthOffset) {
        const container = document.getElementById('calendar-container');
        const monthTitle = document.getElementById('current-month');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Calculate the month to display
        const displayDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        
        // Update month title
        monthTitle.textContent = displayDate.toLocaleString('en-US', { 
            month: 'long', 
            year: 'numeric' 
        });
        
        // Clear container
        container.innerHTML = '';
        
        // Calendar grid
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Day headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            grid.appendChild(header);
        });
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            grid.appendChild(emptyDay);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            dayCell.textContent = day;
            
            if (date < today) {
                dayCell.classList.add('past');
            } else if (isDateAffectedBy14Rule(date)) {
                dayCell.classList.add('unavailable-after-2pm');
                dayCell.title = 'Unavailable after 2 PM today';
            } else if (isDateBooked(date)) {
                dayCell.classList.add('booked');
                dayCell.title = 'This date is booked';
            } else {
                dayCell.classList.add('available');
                dayCell.title = 'This date is available';
            }
            
            grid.appendChild(dayCell);
        }
        
        container.appendChild(grid);
        
        // Update button states
        document.getElementById('prev-month').disabled = monthOffset <= 0;
    }
    
    // Event listeners for navigation
    document.addEventListener('DOMContentLoaded', function() {
        // Generate initial calendar
        generateCalendar(currentMonth);
        
        // Previous month button
        document.getElementById('prev-month').addEventListener('click', function() {
            if (currentMonth > 0) {
                currentMonth--;
                generateCalendar(currentMonth);
            }
        });
        
        // Next month button
        document.getElementById('next-month').addEventListener('click', function() {
            currentMonth++;
            generateCalendar(currentMonth);
        });
    });
</script>
{% endblock %}


