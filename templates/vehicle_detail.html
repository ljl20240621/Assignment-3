{% extends "base.html" %}

{% block title %}{{ vehicle.make }} {{ vehicle.model }} - Vehicle Rental System{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <a href="{{ url_for('customer.vehicles') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Vehicles
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <img src="{{ url_for('static', filename='images/' + vehicle.__class__.__name__.lower() + '.jpg') }}" 
                 class="card-img-top" 
                 alt="{{ vehicle.make }} {{ vehicle.model }}"
                 onerror="this.src='{{ url_for('static', filename='images/default.jpg') }}'">
            <div class="card-body">
                <h2 class="card-title">{{ vehicle.make }} {{ vehicle.model }}</h2>
                <p class="lead">
                    <span class="badge bg-secondary">{{ vehicle.__class__.__name__ }}</span>
                    <span class="badge bg-info">{{ vehicle.year }}</span>
                </p>
                
                <h3 class="text-primary mb-3">${{ vehicle.daily_rate|round(2) }}<small class="text-muted">/day</small></h3>
                
                <h5>Specifications:</h5>
                <ul class="list-group mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Vehicle ID:</strong></span>
                        <code>{{ vehicle.vehicle_id }}</code>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Make:</strong></span>
                        <span>{{ vehicle.make }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Model:</strong></span>
                        <span>{{ vehicle.model }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Year:</strong></span>
                        <span>{{ vehicle.year }}</span>
                    </li>
                    {% if vehicle.__class__.__name__ == 'Car' %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Doors:</strong></span>
                        <span>{{ vehicle.num_doors }}</span>
                    </li>
                    {% elif vehicle.__class__.__name__ == 'Motorbike' %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Engine:</strong></span>
                        <span>{{ vehicle.engine_cc }}cc</span>
                    </li>
                    {% elif vehicle.__class__.__name__ == 'Truck' %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Load Capacity:</strong></span>
                        <span>{{ vehicle.load_capacity_tons }}t</span>
                    </li>
                    {% endif %}
                </ul>
                
                {% if user.kind != 'Staff' %}
                <div class="d-grid gap-2">
                    <a href="{{ url_for('customer.rent_vehicle', vehicle_id=vehicle.vehicle_id) }}" class="btn btn-success btn-lg">
                        <i class="bi bi-cart-plus"></i> Rent This Vehicle
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Rental Information</h5>
            </div>
            <div class="card-body">
                <h6>Your Discount:</h6>
                {% if user.kind == 'Corporate' %}
                <p class="text-success"><strong>15% discount</strong> on all rentals as a Corporate user!</p>
                {% elif user.kind == 'Individual' %}
                <p class="text-success"><strong>10% discount</strong> for rentals of 7 days or more!</p>
                {% else %}
                <p class="text-muted">Staff members cannot rent vehicles.</p>
                {% endif %}
                
                {% if user.kind != 'Staff' %}
                <h6 class="mt-3">Price Breakdown:</h6>
                <ul>
                    <li>Base rate: ${{ vehicle.daily_rate|round(2) }}/day</li>
                    {% if vehicle.__class__.__name__ == 'Car' %}
                        {% if vehicle.num_doors <= 2 %}
                        <li>Sports car premium: +10%</li>
                        {% elif vehicle.num_doors >= 5 %}
                        <li>Large vehicle premium: +5%</li>
                        {% endif %}
                    {% elif vehicle.__class__.__name__ == 'Motorbike' %}
                        <li>Helmet fee: $5/day</li>
                        {% if vehicle.engine_cc >= 600 %}
                        <li>High displacement premium: +5%</li>
                        {% endif %}
                    {% elif vehicle.__class__.__name__ == 'Truck' %}
                        <li>Logistics fee: $20</li>
                        {% if vehicle.load_capacity_tons > 3.0 %}
                        <li>Heavy load surcharge: +10%</li>
                        {% endif %}
                    {% endif %}
                    <li>Your discount applied at checkout</li>
                </ul>
                {% endif %}
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Availability Calendar</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Green dates are available, Red dates are booked.</p>
                <div id="calendar-container"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Rental History</h5>
            </div>
            <div class="card-body">
                {% if rental_history %}
                <p class="text-muted">This vehicle has been rented <strong>{{ rental_history|length }}</strong> time(s).</p>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rental in rental_history | reverse %}
                            <tr>
                                <td>{{ rental.period.start_date }} to {{ rental.period.end_date }}</td>
                                <td>
                                    {% if rental.returned %}
                                    <span class="badge bg-success">Returned</span>
                                    {% else %}
                                    <span class="badge bg-primary">Active</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">This vehicle has not been rented yet. Be the first!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .card-img-top {
        height: 300px;
        object-fit: cover;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin-top: 10px;
    }
    
    .calendar-header {
        text-align: center;
        font-weight: bold;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .calendar-day {
        text-align: center;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .calendar-day:hover {
        transform: scale(1.05);
    }
    
    .calendar-day.empty {
        background-color: #f8f9fa;
        border: none;
        cursor: default;
    }
    
    .calendar-day.available {
        background-color: #d1e7dd;
        color: #0f5132;
        border-color: #a3cfbb;
    }
    
    .calendar-day.booked {
        background-color: #f8d7da;
        color: #842029;
        border-color: #f1aeb5;
    }
    
    .calendar-day.past {
        background-color: #e9ecef;
        color: #6c757d;
        border-color: #ced4da;
        cursor: default;
    }
    
    .calendar-month-header {
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin: 20px 0 10px 0;
        padding: 10px;
        background-color: #0d6efd;
        color: white;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const bookedRanges = {{ booked_ranges|safe }};
    
    // Helper function to parse date string (DD-MM-YYYY HH:MM)
    function parseDate(dateStr) {
        const parts = dateStr.split(' ');
        const datePart = parts[0].split('-');
        return new Date(datePart[2], datePart[1] - 1, datePart[0]);
    }
    
    // Check if a date is booked
    function isDateBooked(date) {
        const dateStr = date.toISOString().split('T')[0];
        for (let range of bookedRanges) {
            const start = new Date(range.start);
            const end = new Date(range.end);
            if (date >= start && date <= end) {
                return true;
            }
        }
        return false;
    }
    
    // Generate calendar for the next 3 months
    function generateCalendar() {
        const container = document.getElementById('calendar-container');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Generate for next 3 months
        for (let monthOffset = 0; monthOffset < 3; monthOffset++) {
            const currentDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Month header
            const monthHeader = document.createElement('div');
            monthHeader.className = 'calendar-month-header';
            monthHeader.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            container.appendChild(monthHeader);
            
            // Calendar grid
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                grid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                if (date < today) {
                    dayCell.classList.add('past');
                } else if (isDateBooked(date)) {
                    dayCell.classList.add('booked');
                    dayCell.title = 'This date is booked';
                } else {
                    dayCell.classList.add('available');
                    dayCell.title = 'This date is available';
                }
                
                grid.appendChild(dayCell);
            }
            
            container.appendChild(grid);
        }
    }
    
    // Generate calendar when page loads
    document.addEventListener('DOMContentLoaded', generateCalendar);
</script>
{% endblock %}

